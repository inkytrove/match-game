<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†</title>
  <!-- Ù†Ø¶ÙŠÙ viewport-fit=cover Ù„Ù…Ù†Ø¹ Ø§Ù„ÙØ±Ø§ØºØ§Øª Ø§Ù„Ø¨ÙŠØ¶Ø§Ø¡ Ø¹Ù„Ù‰ iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- Ø®Ø·Ù‘ Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700&display=swap" rel="stylesheet">

  <style>
    /* 1. html Ø´ÙØ§ÙØŒ body ÙŠØºØ·ÙŠ ÙƒØ§Ù…Ù„ Ø§Ù„Ø´Ø§Ø´Ø© Ø¨Ø§Ù„Ø®Ù„ÙÙŠØ© Ø§Ù„Ø®Ø¶Ø±Ø§Ø¡ */
    html {
      height: 100%;
      margin: 0;
      padding: 0;
      background: transparent;
    }
    body {
      min-height: 100vh;
      margin: 0;
      /* safe-area-inset + 20px Ù…Ø³Ø§Ø­Ø© ÙÙˆÙ‚ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† */
      padding-top: calc(env(safe-area-inset-top) + 20px);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);

      background: linear-gradient(135deg, #1b5e20, #004d40);
      background-attachment: fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
      font-family: 'Tajawal', sans-serif;
      overflow-x: hidden;
    }

    /* 2. Ù†Ø²ÙŠÙ„ Ø£ÙŠÙ‘ Ù‡ÙˆØ§Ù…Ø´ Ø£Ùˆ padding Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù…Ù† ÙƒÙ„ Ø¹Ù†ØµØ± */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
    }

    /* 3. ØªØ±ÙˆÙŠØ³Ø© Ø§Ù„ØµÙØ­Ø© Ù…Ø¹ Ù…Ø³Ø§ÙØ© Ø¹Ù„ÙˆÙŠØ© Ù…Ø¯Ù…Ø¬Ø© ÙÙŠ body */
    header {
      text-align: center;
      width: 100%;
      margin-bottom: 12px;
    }
    header h1 {
      font-size: 2.4rem;
      margin-bottom: 6px;
    }
    #roomDisplay {
      font-size: 1rem;
      color: #c5e1a5;
      margin-bottom: 4px;
    }
    #teamName {
      font-size: 1.4rem;
      margin-bottom: 8px;
      font-weight: 700;
    }
    #roundName {
      font-size: 1.2rem;
      margin-bottom: 12px;
      font-weight: 700;
    }
    .instructions {
      font-size: 1rem;
      margin-bottom: 16px;
    }

    /* 4. Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + Ù†Ù‚Ø§Ø·Ù‡Ù… */
    #playersScores {
      margin-bottom: 12px;
      width: 100%;
      max-width: 360px;
      list-style: none;
      padding: 0;
    }
    #playersScores li {
      font-size: 1rem;
      margin-bottom: 4px;
      color: #c5e1a5;
    }

    /* 5. Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ */
    .controls {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 360px;
      margin-bottom: 16px;
    }
    .controls button {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      background: #38a169;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.2s, transform 0.1s;
    }
    .controls button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .controls button:hover:not(:disabled) {
      background: #2f855a;
    }
    .controls button:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* 6. Ù„ÙˆØ­Ø§Øª Ø§Ù„ØµÙˆØ± Ùˆ Ø®Ø§Ù†Ø§Øª Ø§Ù„ØªØ®Ù…ÙŠÙ† */
    #board,
    #slots {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 12px;
    }
    .slot {
      width: calc((100% - 5 * 6px) / 6);
      aspect-ratio: 1;
      background: transparent;
      border: 2px solid #a5d6a7;
      border-radius: 4px;
      position: relative;
    }
    .slot img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* 7. ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© */
    #feedback {
      font-size: 1rem;
      margin-bottom: 12px;
      text-align: center;
      visibility: hidden;
      font-weight: 700;
    }

    /* 8. Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ */
    #correctAnswer {
      display: none;
      margin-top: 16px;
      width: 100%;
      max-width: 800px;
      background: transparent;
    }
    #correctAnswer .label {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #c5e1a5;
      font-weight: 700;
    }
    #correctAnswer .grid {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 16px;
      background: transparent;
    }
    #correctAnswer .grid .slot {
      width: calc((100% - 5 * 6px) / 6);
      background: rgba(255,255,255,0.1);
      border: none;
    }
    #correctAnswer .grid .slot img {
      border: 2px solid #a5d6a7;
    }

    /* 9. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø¹Ù…ÙˆØ¯ÙŠÙ‹Ø§ */
    @media (max-width: 480px) {
      body {
        padding-top: calc(env(safe-area-inset-top) + 20px);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
      }
      #playersScores li {
        font-size: 0.9rem;
      }
      #board,
      #slots,
      #correctAnswer .grid {
        gap: 4px;
        max-width: 100%;
      }
      .slot {
        width: calc((100% - 5 * 4px) / 6);
      }
    }

    /* 10. Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø¬Ù‡Ø§Ø² Ø£ÙÙ‚ÙŠÙ‹Ø§ */
    @media (orientation: landscape) and (max-width: 767px) {
      body {
        padding-top: calc(env(safe-area-inset-top) + 20px);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
      }
      #playersScores li {
        font-size: 0.85rem;
      }
      #board,
      #slots,
      #correctAnswer .grid {
        gap: 8px;
        max-width: 100vw;
      }
      .slot {
        width: calc((100% - 5 * 8px) / 6);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>Ù„Ø¹Ø¨Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ†</h1>
    <div id="roomDisplay">Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: â€”</div>
    <div id="teamName">ÙØ±ÙŠÙ‚</div>
    <div id="roundName">Ø§Ù„Ø¬ÙˆÙ„Ø©: â€”</div>
    <div class="instructions">Ø§Ø³Ø­Ø¨ Ø§Ù„ØµÙˆØ± Ø£Ùˆ Ø¨Ø¯Ù‘Ù„ Ø¨ÙŠÙ†Ù‡Ø§ Ø«Ù… Ø§Ø¶ØºØ· "ØªØ£ÙƒÙŠØ¯"</div>
  </header>

  <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† + Ù†Ù‚Ø§Ø·Ù‡Ù… -->
  <ul id="playersScores"></ul>

  <!-- Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¨Ø¯Ø¡ ÙˆØ§Ù„ØªØ£ÙƒÙŠØ¯ -->
  <div class="controls">
    <button id="startBtn">Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©</button>
    <button id="submit" disabled>ØªØ£ÙƒÙŠØ¯</button>
  </div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØµÙˆØ± Ø§Ù„Ø£ØµÙ„ÙŠØ© (Ù¦ ØµÙˆØ±) -->
  <div id="board"></div>

  <!-- Ù„ÙˆØ­Ø© Ø§Ù„ØªØ®Ù…ÙŠÙ† (Ù¦ Ø®Ø§Ù†Ø§Øª) -->
  <div id="slots"></div>

  <!-- ØªØºØ°ÙŠØ© Ø±Ø§Ø¬Ø¹Ø© Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø© -->
  <div id="feedback">Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: 0 Ù…Ù† 0</div>

  <!-- Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­ (Ù¦ ØµÙˆØ±) -->
  <div id="correctAnswer">
    <div class="label">Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„ØµØ­ÙŠØ­:</div>
    <div class="grid" id="answerGrid"></div>
  </div>

  <script>
    const socket = io();

    // 1. Ù†Ù‚Ø±Ø£ roomId Ùˆ playerName Ù…Ù† Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙØ­Ø©
    const params     = new URLSearchParams(location.search);
    const roomId     = params.get('room') || 'eid-room';
    let playerName   = params.get('name') || prompt('Ø£Ø¯Ø®Ù„ Ø§Ø³Ù…Ùƒ');
    playerName       = decodeURIComponent(playerName);

    // 2. Ù†ØªØ­Ù‚Ù‘Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ù„Ø¹Ø¨Ø© Ø£ÙˆÙ„Ù‹Ø§
    socket.emit('checkGameStatus', { roomId });

    socket.on('gameStatus', ({ inProgress }) => {
      if (inProgress) {
        alert('Ø¹Ø°Ø±Ù‹Ø§ØŒ Ø§Ù„Ø¬ÙˆÙ„Ø© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„ØºØ±ÙØ© Ø¨Ø¯Ø£Øª Ø¨Ø§Ù„ÙØ¹Ù„.');
        window.location.href = 'index.html';
      } else {
        attemptJoin();
      }
    });

    // 3. Ø¯Ø§Ù„Ø© Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ù„ØºØ±ÙØ© Ù„Ù…Ø±Ø© ÙˆØ§Ø­Ø¯Ø© ÙÙ‚Ø·
    function attemptJoin() {
      const storageKey = `joined_${roomId}_${playerName}`;
      if (!sessionStorage.getItem(storageKey)) {
        socket.emit('joinRoom', { roomId, playerName });
        sessionStorage.setItem(storageKey, 'true');
      }
    }

    // 4. Ù†ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø±ÙØ¶ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… (errorJoin)
    socket.on('errorJoin', ({ message }) => {
      alert(message || 'Ù„Ø§ ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… Ø§Ù„Ø¢Ù†.');
      window.location.href = 'index.html';
    });

    // 5. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù„Ø§Ø¹Ø¨ÙŠÙ† ÙˆØ§Ù„Ù†Ù‚Ø§Ø·
    const roomDisplay   = document.getElementById('roomDisplay');
    const playersScores = document.getElementById('playersScores');
    const teamEl        = document.getElementById('teamName');
    const roundEl       = document.getElementById('roundName');
    const startBtn      = document.getElementById('startBtn');
    const submitBtn     = document.getElementById('submit');
    const boardEl       = document.getElementById('board');
    const slotsEl       = document.getElementById('slots');
    const fb            = document.getElementById('feedback');
    const correctAnswer = document.getElementById('correctAnswer');
    const answerGrid    = document.getElementById('answerGrid');
    let items = [], draggedImg = null;

    // 6. Ø¹Ø±Ø¶ Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ© ÙˆØ§Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
    roomDisplay.textContent = `Ø±Ù…Ø² Ø§Ù„ØºØ±ÙØ©: ${roomId}`;
    teamEl.textContent      = playerName;

    socket.on('stateMulti', ({ scores: sc, players }) => {
      playersScores.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const pts = sc[p.name] || 0;
        li.textContent = `${p.name}: ${pts} Ù†Ù‚Ø·Ø©`;
        playersScores.appendChild(li);
      });
    });

    socket.on('errorMulti', ({ message }) => {
      alert(message);
    });

    // 7. Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø©
    startBtn.addEventListener('click', () => {
      socket.emit('startRound', { roomId });
      startBtn.disabled = true;
    });

    // 8. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø¬ÙˆÙ„Ø©
    socket.on('roundStartedMulti', ({ items: newItems, roundName: cat, scores: sc, currentRound, players }) => {
      items = newItems;
      roundEl.textContent = `Ø§Ù„Ø¬ÙˆÙ„Ø© ${currentRound}: ${translateCategory(cat)}`;
      playersScores.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const pts = sc[p.name] || 0;
        li.textContent = `${p.name}: ${pts} Ù†Ù‚Ø·Ø©`;
        playersScores.appendChild(li);
      });
      fb.style.visibility = 'visible';
      fb.textContent = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: 0 Ù…Ù† ${items.length}`;
      submitBtn.disabled = false;
      correctAnswer.style.display = 'none';
      answerGrid.innerHTML = '';

      // Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù„ÙˆØ­Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ©
      boardEl.innerHTML = '';
      items.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.addEventListener('dragover', e => e.preventDefault());
        slot.addEventListener('drop', dropOnBoard);

        const img = document.createElement('img');
        img.src       = src;
        img.draggable = true;
        img.addEventListener('dragstart', e => {
          draggedImg = e.target;
          e.dataTransfer.setData('text/plain', src);
          e.dataTransfer.setData('from', 'board');
        });

        slot.appendChild(img);
        boardEl.appendChild(slot);
      });

      // Ø¨Ù†Ø§Ø¡ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„ØªØ®Ù…ÙŠÙ†
      slotsEl.innerHTML = '';
      items.forEach(() => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.addEventListener('dragover', e => e.preventDefault());
        slot.addEventListener('drop', dropOnSlot);
        slotsEl.appendChild(slot);
      });
    });

    // 9. Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ£ÙƒÙŠØ¯"
    submitBtn.addEventListener('click', () => {
      const order = Array.from(slotsEl.children).map(s => {
        const img = s.querySelector('img');
        return img ? img.getAttribute('src').replace(location.origin, '') : null;
      });
      socket.emit('submitOrder', { roomId, playerId: playerName, order });
    });

    socket.on('feedbackMulti', ({ player, correctCount, total }) => {
      if (player === playerName) {
        fb.textContent = `Ø§Ù„Ø¥Ø¬Ø§Ø¨Ø§Øª Ø§Ù„ØµØ­ÙŠØ­Ø©: ${correctCount} Ù…Ù† ${total}`;
      }
    });

    socket.on('roundWinMulti', ({ scores: sc, winners, roundNumber, answer }) => {
      playersScores.innerHTML = '';
      Object.entries(sc).forEach(([name, pts]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${pts} Ù†Ù‚Ø·Ø©`;
        playersScores.appendChild(li);
      });
      if (winners.includes(playerName)) {
        fb.textContent = `ğŸ‰ Ù„Ù‚Ø¯ ÙØ²Øª ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©!`;
      } else {
        fb.textContent = `ğŸ˜¢ Ø®Ø³Ø±Øª Ù‡Ø°Ù‡ Ø§Ù„Ø¬ÙˆÙ„Ø©!`;
      }
      answerGrid.innerHTML = '';
      answer.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const img = document.createElement('img');
        img.src = src;
        img.draggable = false;
        slot.appendChild(img);
        answerGrid.appendChild(slot);
      });
      correctAnswer.style.display = 'block';
      submitBtn.disabled = true;
    });

    socket.on('enableStartNext', () => {
      startBtn.disabled   = false;
      startBtn.textContent = 'Ø¨Ø¯Ø¡ Ø§Ù„Ø¬ÙˆÙ„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©';
    });

    socket.on('finalGameEndMulti', ({ scores: sc, finalWinners }) => {
      playersScores.innerHTML = '';
      Object.entries(sc).forEach(([name, pts]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${pts} Ù†Ù‚Ø·Ø©`;
        playersScores.appendChild(li);
      });
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top      = '0';
      overlay.style.left     = '0';
      overlay.style.width    = '100%';
      overlay.style.height   = '100%';
      overlay.style.background = 'rgba(0,0,0,0.8)';
      overlay.style.display    = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems     = 'center';
      overlay.style.color        = '#fff';
      overlay.style.fontSize     = '2rem';
      overlay.style.zIndex       = '999';
      overlay.style.textAlign    = 'center';
      overlay.style.padding      = '20px';
      let message = '';
      if (finalWinners.includes(playerName)) {
        message = 'ğŸ‰ Ø£Ù„Ù Ù…Ø¨Ø±ÙˆÙƒ! Ø£Ù†Øª Ø§Ù„ÙØ§Ø¦Ø²!';
      } else if (finalWinners.length === 1 && !finalWinners.includes(playerName)) {
        message = 'ğŸ˜¢ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø©. ÙØ§Ø² Ù„Ø§Ø¹Ø¨ Ø¢Ø®Ø±.';
      } else {
        message = 'âš–ï¸ Ø§Ù†ØªÙ‡Øª Ø§Ù„Ù„Ø¹Ø¨Ø© Ø¨ØªØ¹Ø§Ø¯Ù„ Ø¨ÙŠÙ†:\n' + finalWinners.join(' Ùˆ ');
      }
      message.split('\n').forEach((ln, idx) => {
        const p = document.createElement('div');
        p.textContent = ln;
        if (idx === 0) p.style.marginBottom = '12px';
        overlay.appendChild(p);
      });
      document.body.appendChild(overlay);
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 5000);
    });

    function dropOnSlot(e) {
      e.preventDefault();
      const from = e.dataTransfer.getData('from');
      const url  = e.dataTransfer.getData('text/plain');
      if (from === 'board') {
        if (e.currentTarget.querySelector('img')) return;
        const orig = boardEl.querySelector(`img[src="${url}"]`);
        if (orig) orig.remove();
        const img = document.createElement('img');
        img.src = url;
        img.draggable = true;
        img.addEventListener('dragstart', ev => {
          draggedImg = ev.target;
          ev.dataTransfer.setData('text/plain', url);
          ev.dataTransfer.setData('from', 'slot');
        });
        e.currentTarget.appendChild(img);
      } else if (from === 'slot') {
        if (!draggedImg) return;
        if (!e.currentTarget.querySelector('img')) {
          const parentOfDragged = draggedImg.parentElement;
          parentOfDragged.removeChild(draggedImg);
          e.currentTarget.appendChild(draggedImg);
        } else {
          const targetImg = e.currentTarget.querySelector('img');
          const tempSrc = targetImg.src;
          targetImg.src = draggedImg.src;
          draggedImg.src = tempSrc;
        }
      }
    }
    function dropOnBoard(e) {
      e.preventDefault();
      if (e.dataTransfer.getData('from') !== 'slot') return;
      if (e.currentTarget.querySelector('img')) return;
      if (draggedImg) {
        const parentOfDragged = draggedImg.parentElement;
        parentOfDragged.removeChild(draggedImg);
        e.currentTarget.appendChild(draggedImg);
      }
    }

    function translateCategory(cat) {
      const catNames = {
        fruits:  'Ø§Ù„ÙÙˆØ§ÙƒÙ‡',
        drinks:  'Ø§Ù„Ù…Ø´Ø±ÙˆØ¨Ø§Øª',
        tools:   'Ø§Ù„Ø£Ø¯ÙˆØ§Øª',
        veggies: 'Ø§Ù„Ø®Ø¶Ø±ÙˆØ§Øª',
        animals: 'Ø§Ù„Ø­ÙŠÙˆØ§Ù†Ø§Øª'
      };
      return catNames[cat] || cat;
    }
  </script>
</body>
</html>
