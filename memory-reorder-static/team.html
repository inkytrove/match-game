<!DOCTYPE html>
<html lang="ar">
<head>
  <meta charset="UTF-8">
  <title>لعبة التخمين</title>
  <!-- نضيف viewport-fit=cover لمنع الفراغات البيضاء على iOS -->
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">

  <!-- Socket.IO -->
  <script src="/socket.io/socket.io.js"></script>
  <!-- خطّ Tajawal -->
  <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@700&display=swap" rel="stylesheet">

  <style>
    /* 1. html شفاف، body يغطي كامل الشاشة بالخلفية الخضراء */
    html {
      height: 100%;
      margin: 0;
      padding: 0;
      background: transparent;
    }
    body {
      min-height: 100vh;
      margin: 0;
      /* safe-area-inset + 20px مساحة فوق العنوان */
      padding-top: calc(env(safe-area-inset-top) + 20px);
      padding-right: env(safe-area-inset-right);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);

      background: linear-gradient(135deg, #1b5e20, #004d40);
      background-attachment: fixed;
      background-size: cover;
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #fff;
      font-family: 'Tajawal', sans-serif;
      overflow-x: hidden;
    }

    /* 2. نزيل أيّ هوامش أو padding افتراضية من كل عنصر */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      user-select: none;
    }

    /* 3. ترويسة الصفحة مع مسافة علوية مدمجة في body */
    header {
      text-align: center;
      width: 100%;
      margin-bottom: 12px;
    }
    header h1 {
      font-size: 2.4rem;
      margin-bottom: 6px;
    }
    #roomDisplay {
      font-size: 1rem;
      color: #c5e1a5;
      margin-bottom: 4px;
    }
    #teamName {
      font-size: 1.4rem;
      margin-bottom: 8px;
      font-weight: 700;
    }
    #roundName {
      font-size: 1.2rem;
      margin-bottom: 12px;
      font-weight: 700;
    }
    .instructions {
      font-size: 1rem;
      margin-bottom: 16px;
    }

    /* 4. قائمة اللاعبين + نقاطهم */
    #playersScores {
      margin-bottom: 12px;
      width: 100%;
      max-width: 360px;
      list-style: none;
      padding: 0;
    }
    #playersScores li {
      font-size: 1rem;
      margin-bottom: 4px;
      color: #c5e1a5;
    }

    /* 5. أزرار البدء والتأكيد */
    .controls {
      display: flex;
      gap: 10px;
      width: 100%;
      max-width: 360px;
      margin-bottom: 16px;
    }
    .controls button {
      flex: 1;
      padding: 10px;
      font-size: 1rem;
      background: #38a169;
      border: none;
      border-radius: 4px;
      color: #fff;
      cursor: pointer;
      font-weight: 700;
      transition: background 0.2s, transform 0.1s;
    }
    .controls button:disabled {
      background: #555;
      cursor: not-allowed;
    }
    .controls button:hover:not(:disabled) {
      background: #2f855a;
    }
    .controls button:active:not(:disabled) {
      transform: scale(0.98);
    }

    /* 6. لوحات الصور و خانات التخمين */
    #board,
    #slots {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 12px;
    }
    .slot {
      width: calc((100% - 5 * 6px) / 6);
      aspect-ratio: 1;
      background: transparent;
      border: 2px solid #a5d6a7;
      border-radius: 4px;
      position: relative;
    }
    .slot img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 4px;
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }

    /* 7. تغذية راجعة */
    #feedback {
      font-size: 1rem;
      margin-bottom: 12px;
      text-align: center;
      visibility: hidden;
      font-weight: 700;
    }

    /* 8. عرض الترتيب الصحيح */
    #correctAnswer {
      display: none;
      margin-top: 16px;
      width: 100%;
      max-width: 800px;
      background: transparent;
    }
    #correctAnswer .label {
      font-size: 1rem;
      margin-bottom: 8px;
      text-align: center;
      color: #c5e1a5;
      font-weight: 700;
    }
    #correctAnswer .grid {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      width: 100%;
      max-width: 800px;
      margin-bottom: 16px;
      background: transparent;
    }
    #correctAnswer .grid .slot {
      width: calc((100% - 5 * 6px) / 6);
      background: rgba(255,255,255,0.1);
      border: none;
    }
    #correctAnswer .grid .slot img {
      border: 2px solid #a5d6a7;
    }

    /* 9. إذا كان الجهاز عموديًا */
    @media (max-width: 480px) {
      body {
        padding-top: calc(env(safe-area-inset-top) + 20px);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
      }
      #playersScores li {
        font-size: 0.9rem;
      }
      #board,
      #slots,
      #correctAnswer .grid {
        gap: 4px;
        max-width: 100%;
      }
      .slot {
        width: calc((100% - 5 * 4px) / 6);
      }
    }

    /* 10. إذا كان الجهاز أفقيًا */
    @media (orientation: landscape) and (max-width: 767px) {
      body {
        padding-top: calc(env(safe-area-inset-top) + 20px);
        padding-right: env(safe-area-inset-right);
        padding-bottom: env(safe-area-inset-bottom);
        padding-left: env(safe-area-inset-left);
      }
      #playersScores li {
        font-size: 0.85rem;
      }
      #board,
      #slots,
      #correctAnswer .grid {
        gap: 8px;
        max-width: 100vw;
      }
      .slot {
        width: calc((100% - 5 * 8px) / 6);
      }
    }
  </style>
</head>
<body>
  <header>
    <h1>لعبة التخمين</h1>
    <div id="roomDisplay">رمز الغرفة: —</div>
    <div id="teamName">فريق</div>
    <div id="roundName">الجولة: —</div>
    <div class="instructions">اسحب الصور أو بدّل بينها ثم اضغط "تأكيد"</div>
  </header>

  <!-- قائمة اللاعبين + نقاطهم -->
  <ul id="playersScores"></ul>

  <!-- أزرار البدء والتأكيد -->
  <div class="controls">
    <button id="startBtn">بدء الجولة</button>
    <button id="submit" disabled>تأكيد</button>
  </div>

  <!-- لوحة الصور الأصلية (٦ صور) -->
  <div id="board"></div>

  <!-- لوحة التخمين (٦ خانات) -->
  <div id="slots"></div>

  <!-- تغذية راجعة لعدد الإجابات الصحيحة -->
  <div id="feedback">الإجابات الصحيحة: 0 من 0</div>

  <!-- عرض الترتيب الصحيح (٦ صور) -->
  <div id="correctAnswer">
    <div class="label">الترتيب الصحيح:</div>
    <div class="grid" id="answerGrid"></div>
  </div>

  <script>
    const socket = io();

    // 1. نقرأ roomId و playerName من رابط الصفحة
    const params     = new URLSearchParams(location.search);
    const roomId     = params.get('room') || 'eid-room';
    let playerName   = params.get('name') || prompt('أدخل اسمك');
    playerName       = decodeURIComponent(playerName);

    // 2. نتحقّق من حالة اللعبة أولًا
    socket.emit('checkGameStatus', { roomId });

    socket.on('gameStatus', ({ inProgress }) => {
      if (inProgress) {
        alert('عذرًا، الجولة في هذه الغرفة بدأت بالفعل.');
        window.location.href = 'index.html';
      } else {
        attemptJoin();
      }
    });

    // 3. دالة الانضمام لغرفة لمرة واحدة فقط
    function attemptJoin() {
      const storageKey = `joined_${roomId}_${playerName}`;
      if (!sessionStorage.getItem(storageKey)) {
        socket.emit('joinRoom', { roomId, playerName });
        sessionStorage.setItem(storageKey, 'true');
      }
    }

    // 4. نتعامل مع رفض الانضمام (errorJoin)
    socket.on('errorJoin', ({ message }) => {
      alert(message || 'لا يمكنك الانضمام الآن.');
      window.location.href = 'index.html';
    });

    // 5. استقبال تحديث قائمة اللاعبين والنقاط
    const roomDisplay   = document.getElementById('roomDisplay');
    const playersScores = document.getElementById('playersScores');
    const teamEl        = document.getElementById('teamName');
    const roundEl       = document.getElementById('roundName');
    const startBtn      = document.getElementById('startBtn');
    const submitBtn     = document.getElementById('submit');
    const boardEl       = document.getElementById('board');
    const slotsEl       = document.getElementById('slots');
    const fb            = document.getElementById('feedback');
    const correctAnswer = document.getElementById('correctAnswer');
    const answerGrid    = document.getElementById('answerGrid');
    let items = [], draggedImg = null;

    // 6. عرض رمز الغرفة واسم اللاعب
    roomDisplay.textContent = `رمز الغرفة: ${roomId}`;
    teamEl.textContent      = playerName;

    socket.on('stateMulti', ({ scores: sc, players }) => {
      playersScores.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const pts = sc[p.name] || 0;
        li.textContent = `${p.name}: ${pts} نقطة`;
        playersScores.appendChild(li);
      });
    });

    socket.on('errorMulti', ({ message }) => {
      alert(message);
    });

    // 7. بدء الجولة
    startBtn.addEventListener('click', () => {
      socket.emit('startRound', { roomId });
      startBtn.disabled = true;
    });

    // 8. استقبال بداية الجولة
    socket.on('roundStartedMulti', ({ items: newItems, roundName: cat, scores: sc, currentRound, players }) => {
      items = newItems;
      roundEl.textContent = `الجولة ${currentRound}: ${translateCategory(cat)}`;
      playersScores.innerHTML = '';
      players.forEach(p => {
        const li = document.createElement('li');
        const pts = sc[p.name] || 0;
        li.textContent = `${p.name}: ${pts} نقطة`;
        playersScores.appendChild(li);
      });
      fb.style.visibility = 'visible';
      fb.textContent = `الإجابات الصحيحة: 0 من ${items.length}`;
      submitBtn.disabled = false;
      correctAnswer.style.display = 'none';
      answerGrid.innerHTML = '';

      // بناء اللوحة الأصلية
      boardEl.innerHTML = '';
      items.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.addEventListener('dragover', e => e.preventDefault());
        slot.addEventListener('drop', dropOnBoard);

        const img = document.createElement('img');
        img.src       = src;
        img.draggable = true;
        img.addEventListener('dragstart', e => {
          draggedImg = e.target;
          e.dataTransfer.setData('text/plain', src);
          e.dataTransfer.setData('from', 'board');
        });

        slot.appendChild(img);
        boardEl.appendChild(slot);
      });

      // بناء مربعات التخمين
      slotsEl.innerHTML = '';
      items.forEach(() => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        slot.addEventListener('dragover', e => e.preventDefault());
        slot.addEventListener('drop', dropOnSlot);
        slotsEl.appendChild(slot);
      });
    });

    // 9. عند الضغط على "تأكيد"
    submitBtn.addEventListener('click', () => {
      const order = Array.from(slotsEl.children).map(s => {
        const img = s.querySelector('img');
        return img ? img.getAttribute('src').replace(location.origin, '') : null;
      });
      socket.emit('submitOrder', { roomId, playerId: playerName, order });
    });

    socket.on('feedbackMulti', ({ player, correctCount, total }) => {
      if (player === playerName) {
        fb.textContent = `الإجابات الصحيحة: ${correctCount} من ${total}`;
      }
    });

    socket.on('roundWinMulti', ({ scores: sc, winners, roundNumber, answer }) => {
      playersScores.innerHTML = '';
      Object.entries(sc).forEach(([name, pts]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${pts} نقطة`;
        playersScores.appendChild(li);
      });
      if (winners.includes(playerName)) {
        fb.textContent = `🎉 لقد فزت في هذه الجولة!`;
      } else {
        fb.textContent = `😢 خسرت هذه الجولة!`;
      }
      answerGrid.innerHTML = '';
      answer.forEach(src => {
        const slot = document.createElement('div');
        slot.className = 'slot';
        const img = document.createElement('img');
        img.src = src;
        img.draggable = false;
        slot.appendChild(img);
        answerGrid.appendChild(slot);
      });
      correctAnswer.style.display = 'block';
      submitBtn.disabled = true;
    });

    socket.on('enableStartNext', () => {
      startBtn.disabled   = false;
      startBtn.textContent = 'بدء الجولة التالية';
    });

    socket.on('finalGameEndMulti', ({ scores: sc, finalWinners }) => {
      playersScores.innerHTML = '';
      Object.entries(sc).forEach(([name, pts]) => {
        const li = document.createElement('li');
        li.textContent = `${name}: ${pts} نقطة`;
        playersScores.appendChild(li);
      });
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top      = '0';
      overlay.style.left     = '0';
      overlay.style.width    = '100%';
      overlay.style.height   = '100%';
      overlay.style.background = 'rgba(0,0,0,0.8)';
      overlay.style.display    = 'flex';
      overlay.style.flexDirection = 'column';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems     = 'center';
      overlay.style.color        = '#fff';
      overlay.style.fontSize     = '2rem';
      overlay.style.zIndex       = '999';
      overlay.style.textAlign    = 'center';
      overlay.style.padding      = '20px';
      let message = '';
      if (finalWinners.includes(playerName)) {
        message = '🎉 ألف مبروك! أنت الفائز!';
      } else if (finalWinners.length === 1 && !finalWinners.includes(playerName)) {
        message = '😢 انتهت اللعبة. فاز لاعب آخر.';
      } else {
        message = '⚖️ انتهت اللعبة بتعادل بين:\n' + finalWinners.join(' و ');
      }
      message.split('\n').forEach((ln, idx) => {
        const p = document.createElement('div');
        p.textContent = ln;
        if (idx === 0) p.style.marginBottom = '12px';
        overlay.appendChild(p);
      });
      document.body.appendChild(overlay);
      setTimeout(() => {
        window.location.href = 'index.html';
      }, 5000);
    });

    function dropOnSlot(e) {
      e.preventDefault();
      const from = e.dataTransfer.getData('from');
      const url  = e.dataTransfer.getData('text/plain');
      if (from === 'board') {
        if (e.currentTarget.querySelector('img')) return;
        const orig = boardEl.querySelector(`img[src="${url}"]`);
        if (orig) orig.remove();
        const img = document.createElement('img');
        img.src = url;
        img.draggable = true;
        img.addEventListener('dragstart', ev => {
          draggedImg = ev.target;
          ev.dataTransfer.setData('text/plain', url);
          ev.dataTransfer.setData('from', 'slot');
        });
        e.currentTarget.appendChild(img);
      } else if (from === 'slot') {
        if (!draggedImg) return;
        if (!e.currentTarget.querySelector('img')) {
          const parentOfDragged = draggedImg.parentElement;
          parentOfDragged.removeChild(draggedImg);
          e.currentTarget.appendChild(draggedImg);
        } else {
          const targetImg = e.currentTarget.querySelector('img');
          const tempSrc = targetImg.src;
          targetImg.src = draggedImg.src;
          draggedImg.src = tempSrc;
        }
      }
    }
    function dropOnBoard(e) {
      e.preventDefault();
      if (e.dataTransfer.getData('from') !== 'slot') return;
      if (e.currentTarget.querySelector('img')) return;
      if (draggedImg) {
        const parentOfDragged = draggedImg.parentElement;
        parentOfDragged.removeChild(draggedImg);
        e.currentTarget.appendChild(draggedImg);
      }
    }

    function translateCategory(cat) {
      const catNames = {
        fruits:  'الفواكه',
        drinks:  'المشروبات',
        tools:   'الأدوات',
        veggies: 'الخضروات',
        animals: 'الحيوانات'
      };
      return catNames[cat] || cat;
    }
  </script>
</body>
</html>
